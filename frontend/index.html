<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unite — Mini Frontend (Auth + Register)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --muted:#6b7280; --accent:#2563eb; --danger:#ef4444; --card-shadow:0 6px 18px rgba(12,23,52,0.08);
      font-family:"Inter",system-ui,Segoe UI,Roboto,Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#eef2ff 0%,var(--bg) 60%);color:#0f172a}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{margin:0;font-size:20px}.sub{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px;align-items:start}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:var(--card-shadow)}
    input,select,textarea{padding:10px 12px;border-radius:8px;border:1px solid #e6edf3;font-size:14px}
    button{background:var(--accent);color:#fff;padding:10px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;color:#1e40af;border:1px solid rgba(37,99,235,0.12)}
    button.danger{background:var(--danger);color:#fff}
    .token-box{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-top:8px}
    .token-text{background:linear-gradient(90deg,#f8fafc,#fff);padding:8px 10px;border-radius:8px;font-size:13px;border:1px solid #eef2f6;flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    th,td{text-align:left;padding:10px 8px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
    th{color:var(--muted);font-size:13px;font-weight:600}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#1e40af;font-weight:600;font-size:12px}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    .muted{color:var(--muted);font-size:13px}
    .notice{padding:8px;border-radius:8px;background:#fff6ea;color:#814d00;border:1px solid #ffefd5;margin:8px 0}
    .small{font-size:13px;color:var(--muted)}
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--card);padding:18px;border-radius:10px;width:420px;box-shadow:var(--card-shadow)}
    .row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Unite — Mini Frontend</h1>
        <div class="sub">Now with inline registration if user doesn't exist</div>
      </div>
      <div style="text-align:right">
        <div class="sub">Assignment Brief</div>
        <a class="sub" href="file:///mnt/data/Senior_Backend_Developer_Assignment_Unite.pdf" target="_blank">Open uploaded PDF</a>
      </div>
    </header>

    <div class="grid">
      <!-- left: leads -->
      <div>
        <div class="card">
          <h3>Create / Update Lead</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <input id="leadName" placeholder="Full name" style="flex:1" />
            <input id="leadPhone" placeholder="Phone" style="width:160px" />
            <input id="leadEmail" placeholder="Email" style="width:220px" />
            <button id="createLeadBtn">Create Lead</button>
            <button id="updateLeadBtn" class="ghost">Update Selected</button>
            <button id="clearBtn" class="ghost">Clear</button>
          </div>
          <div class="small">Seeded credentials: <strong>admin@example.com</strong> / <strong>Password123!</strong></div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>Leads</h3>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="filter" placeholder="Filter by phone or name" />
              <button id="refresh" class="ghost">Refresh</button>
            </div>
          </div>
          <table id="leadsTable" aria-label="Leads">
            <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- right: auth & register -->
      <div>
        <div class="card">
          <h3>Auth</h3>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <input id="email" placeholder="email" value="admin@example.com" />
            <input id="password" placeholder="password" type="password" value="Password123!" />
            <div style="display:flex;gap:8px;align-items:center;">
              <button id="login">Login</button>
              <button id="logout" class="ghost">Logout</button>
              <button id="showRegister" class="ghost">Register</button>
            </div>

            <div class="token-box">
              <div class="token-text" id="tokenText">Not logged in</div>
              <div style="display:flex;gap:6px">
                <button id="copyToken" class="ghost">Copy</button>
                <button id="revealToken" class="ghost">Show</button>
              </div>
            </div>

            <div id="authNotice" class="small muted"></div>
          </div>
        </div>

        <!-- Registration card (hidden by default) -->
        <div class="card" id="registerCard" style="margin-top:12px; display:none;">
          <h3>Register New Account</h3>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <input id="regName" placeholder="Full name" />
            <input id="regEmail" placeholder="Email" />
            <input id="regPassword" placeholder="Password" type="password" />
            <select id="regRole">
              <option value="agent">Agent</option>
              <option value="manager">Manager</option>
            </select>
            <div style="display:flex;gap:8px;">
              <button id="registerBtn">Register</button>
              <button id="cancelRegister" class="ghost">Cancel</button>
            </div>
            <div id="regMsg" class="small muted"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3>Quick Actions</h3>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button id="listLeadsSmall" class="ghost">List Leads</button>
            <button id="seedBtn" class="ghost">Run Seed (server)</button>
            <button id="openDocs" class="ghost">Open Swagger Docs</button>
          </div>
          <div class="small">Swagger at <code>/api-docs</code>.</div>
        </div>
      </div>
    </div>

    <footer>
      <div>Built for the Unite assignment — demo UI</div>
    </footer>
  </div>

  <!-- modal -->
  <div class="modal-back" id="modalBack">
    <div class="modal">
      <div style="font-weight:700">Confirm Delete</div>
      <div style="margin-top:8px">Are you sure you want to delete this lead?</div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="modalCancel" class="ghost">Cancel</button>
        <button id="modalDelete" class="danger">Delete</button>
      </div>
    </div>
  </div>

<script>
  // IMPORTANT: absolute backend URL — ensures requests go to port 4000
  const baseUrl = 'http://localhost:4000';

  // auth token persists
  let token = localStorage.getItem('unite_token') || '';
  let selectedLeadId = null;
  let modalResolve = null;
  const tbody = document.querySelector('#leadsTable tbody');

  // --- UI helpers
  const $ = id => document.getElementById(id);
  function setToken(t){
    token = t || '';
    if (t) localStorage.setItem('unite_token', t); else localStorage.removeItem('unite_token');
    $('tokenText').innerText = token ? (token.slice(0,40) + '…') : 'Not logged in';
  }
  function showRegister(show){
    $('registerCard').style.display = show ? 'block' : 'none';
  }
  function showAuthNotice(msg){
    $('authNotice').innerText = msg || '';
  }

  async function api(path, opts = {}) {
  const headers = opts.headers || {};
  if (!headers['Content-Type'] && !(opts.body instanceof FormData)) headers['Content-Type'] = 'application/json';
  const token = localStorage.getItem('unite_token') || '';
  if (token) headers['Authorization'] = 'Bearer ' + token;
  const full = baseUrl + path;
  console.log('[API]', opts.method || 'GET', full, 'headers', headers, 'body', opts.body);
  const res = await fetch(full, { ...opts, headers });
  const text = await res.text();
  let json;
  try { json = JSON.parse(text); } catch(e) { json = text; }
  console.log('[API RES]', res.status, json);
  if (!res.ok) {
    // show visible notice
    const notice = document.getElementById('authNotice') || document.createElement('div');
    notice.id = 'authNotice'; notice.className = 'small muted';
    notice.innerText = 'API error: ' + res.status + ' — ' + (json?.message || JSON.stringify(json));
    document.body.prepend(notice);
    throw { status: res.status, body: json };
  }
  return json;
}

  // API wrapper
  document.getElementById('updateLeadBtn').addEventListener('click', async () => {
  if (!selectedLeadId) return alert('Select a lead first');
  const updates = {
    name: document.getElementById('leadName').value.trim(),
    phone: document.getElementById('leadPhone').value.trim(),
    email: document.getElementById('leadEmail').value.trim()
  };
  try {
    const r = await api('/leads/' + selectedLeadId, { method: 'PUT', body: JSON.stringify(updates) });
    console.log('Lead updated OK:', r);
    alert('Lead updated');
    clearForm();
    refreshLeads();
  } catch (err) {
    console.error('Update failed', err);
    alert('Update failed: ' + (err?.body?.message || JSON.stringify(err)));
  }
});

  // AUTH: login
  $('login').addEventListener('click', async () => {
    showAuthNotice('');
    try {
      const email = $('email').value.trim();
      const password = $('password').value;
      const j = await api('/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) });
      if (j.token) {
        setToken(j.token);
        showAuthNotice('Logged in as ' + (j.user?.email || 'user'));
        refreshLeads();
      }
    } catch (e) {
      console.error('Login error', e);
      if (e.status === 401) {
        // If user invalid -> prompt register
        showAuthNotice('User not found / invalid credentials. You can register below.');
        // prefill registration fields with attempted credentials
        $('regEmail').value = $('email').value.trim();
        $('regName').value = '';
        $('regPassword').value = $('password').value;
        showRegister(true);
      } else {
        showAuthNotice('Login failed: ' + (e.body?.message || e.status));
      }
    }
  });

  // logout
  $('logout').addEventListener('click', () => {
    setToken('');
    showAuthNotice('Logged out');
  });

  // register flow
  $('showRegister').addEventListener('click', () => {
    $('regEmail').value = $('email').value.trim();
    $('regPassword').value = $('password').value;
    showRegister(true);
  });
  $('cancelRegister').addEventListener('click', () => {
    showRegister(false);
    $('regMsg').innerText = '';
  });

  $('registerBtn').addEventListener('click', async () => {
    try {
      const name = $('regName').value.trim();
      const email = $('regEmail').value.trim();
      const password = $('regPassword').value;
      const role = $('regRole').value;
      if (!name || !email || !password) { $('regMsg').innerText = 'Please fill all fields'; return; }
      $('registerBtn').innerText = 'Registering...';
      // call register endpoint
      const r = await api('/auth/register', { method: 'POST', body: JSON.stringify({ name, email, password, role }) });
      // register returns id/email — now login to get token
      try {
        const loginRes = await api('/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) });
        if (loginRes.token) {
          setToken(loginRes.token);
          showAuthNotice('Registered & logged in as ' + email);
          showRegister(false);
          $('regMsg').innerText = '';
          refreshLeads();
        } else {
          $('regMsg').innerText = 'Registered but login failed — try to login manually.';
        }
      } catch (le) {
        console.error('Auto-login after register failed', le);
        $('regMsg').innerText = 'Registered but auto-login failed: ' + (le.body?.message || le.status || '');
      }
    } catch (err) {
      console.error('Register error', err);
      if (err.status === 409) {
        $('regMsg').innerText = 'Email already exists. Try logging in.';
      } else {
        $('regMsg').innerText = 'Register failed: ' + (err.body?.message || err.status);
      }
    } finally {
      $('registerBtn').innerText = 'Register';
    }
  });

  // copy/reveal token
  $('copyToken').addEventListener('click', async () => {
    if (!token) return alert('No token');
    try { await navigator.clipboard.writeText(token); alert('Token copied'); } catch { alert('Copy failed'); }
  });
  $('revealToken').addEventListener('click', () => {
    if (!token) return alert('No token'); prompt('Token:', token);
  });

  // Create lead
  $('createLeadBtn').addEventListener('click', async () => {
    try {
      const body = { name: $('leadName').value.trim(), phone: $('leadPhone').value.trim(), email: $('leadEmail').value.trim() };
      await api('/leads', { method: 'POST', body: JSON.stringify(body) });
      alert('Lead created');
      clearForm(); refreshLeads();
    } catch (e) {
      console.error('Create lead error', e);
      if (e.status === 401) {
        showAuthNotice('Not authorized — login first');
      } else if (e.status === 409) {
        alert('Lead exists: ' + JSON.stringify(e.body));
      } else {
        alert('Create failed: ' + (e.body?.message || e.status));
      }
    }
  });

  // Update lead (diagnostic-enabled)
  $('updateLeadBtn').addEventListener('click', async () => {
    if (!selectedLeadId) return alert('Select a lead first by clicking Update');
    const updates = { name: $('leadName').value.trim(), phone: $('leadPhone').value.trim(), email: $('leadEmail').value.trim() };
    console.log('Attempt update', selectedLeadId, updates, 'token present?', !!token);
    try {
      const res = await api('/leads/' + selectedLeadId, { method: 'PUT', body: JSON.stringify(updates) });
      console.log('Update res', res);
      alert('Lead updated');
      clearForm(); refreshLeads();
    } catch (err) {
      console.error('Update failed', err);
      if (err.status === 401) showAuthNotice('Unauthorized — please login');
      else if (err.status === 403) showAuthNotice('Forbidden — need manager/admin role');
      else alert('Update failed: ' + (err.body?.message || err.status));
    }
  });

  $('clearBtn').addEventListener('click', clearForm);
  function clearForm(){ selectedLeadId = null; $('leadName').value=''; $('leadPhone').value=''; $('leadEmail').value=''; $('updateLeadBtn').classList.add('ghost'); }

  // Leads: list / render
  async function refreshLeads(){
    try {
      const res = await api('/leads');
      const data = res.data || [];
      renderLeads(data);
    } catch (e) {
      console.error('Refresh leads failed', e);
      if (e.status === 401) showAuthNotice('Not logged in');
      else showAuthNotice('Could not fetch leads: ' + (e.body?.message || e.status));
    }
  }
  function renderLeads(leads){
    tbody.innerHTML = '';
    const filter = $('filter').value.trim().toLowerCase();
    leads.filter(l => {
      if (!filter) return true;
      return (l.name||'').toLowerCase().includes(filter) || (l.phone||'').toLowerCase().includes(filter);
    }).forEach(l => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(l.name||'—')}</td>
        <td>${escapeHtml(l.phone||'—')}</td>
        <td>${escapeHtml(l.email||'—')}</td>
        <td><span class="pill">${escapeHtml(l.status||'new')}</span></td>
        <td>
          <button class="ghost" data-id="${l._id}" data-action="update">Update</button>
          <button class="danger" data-id="${l._id}" data-action="delete">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // handle actions
  tbody.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('button');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    if (action === 'update') {
      try {
        const lead = await api('/leads/' + id);
        selectedLeadId = id;
        $('leadName').value = lead.name||'';
        $('leadPhone').value = lead.phone||'';
        $('leadEmail').value = lead.email||'';
        $('updateLeadBtn').classList.remove('ghost');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (e) { console.error(e); alert('Could not load lead'); }
    } else if (action === 'delete') {
      const ok = await confirmModal();
      if (!ok) return;
      try {
        await api('/leads/' + id, { method: 'DELETE' });
        alert('Deleted');
        refreshLeads();
      } catch (e) {
        console.error('Delete failed', e);
        alert('Delete failed: ' + (e.body?.message || e.status));
      }
    }
  });

  // quick buttons
  $('refresh').addEventListener('click', refreshLeads);
  $('listLeadsSmall').addEventListener('click', refreshLeads);
  $('openDocs').addEventListener('click', () => window.open(baseUrl + '/api-docs', '_blank'));
  $('seedBtn').addEventListener('click', async () => {
    try {
      await api('/utils/seed', { method: 'POST' });
      alert('Seed completed on server');
      refreshLeads();
    } catch (e) {
      console.error('Seed failed', e);
      alert('Seed failed: ' + (e.body?.message || e.status));
    }
  });

  // modal
  async function confirmModal(){
    const back = $('modalBack'); back.style.display = 'flex';
    return new Promise((resolve) => { modalResolve = resolve; });
  }
  $('modalCancel').addEventListener('click', () => { $('modalBack').style.display='none'; if (modalResolve) modalResolve(false); });
  $('modalDelete').addEventListener('click', () => { $('modalBack').style.display='none'; if (modalResolve) modalResolve(true); });

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // init UI
  setToken(token);
  refreshLeads();
</script>
</body>
</html>
